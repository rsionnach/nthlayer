{
  "id": "metrics-recommendation",
  "type": "feature",
  "title": "Metrics Recommendation Engine with OpenTelemetry Semantic Conventions",
  "description": "Comprehensive metrics recommendation system that enforces OpenTelemetry Semantic Conventions, provides service-type-specific metric templates, runtime metrics support, and integrates with lint/check-deploy pipeline.",
  "status": "open",
  "priority": "P1",
  "tags": ["feature", "metrics", "opentelemetry", "semantic-conventions", "lint"],
  "created_at": "2026-01-14T00:00:00Z",
  "specification_file": "METRICS_RECOMMENDATION_SPEC.md",
  "specification_summary": {
    "total_lines": 1069,
    "sections": [
      "OpenTelemetry Semantic Conventions (http, rpc, messaging, db, faas)",
      "Service Type Templates (api, grpc, worker, queue-consumer, database-client, gateway, cache)",
      "Runtime Metrics (Python, JVM, Go, Node.js)",
      "CLI Commands (recommend-metrics)",
      "Integration Points (lint, check-deploy)",
      "Module Structure (nthlayer/metrics/)"
    ]
  },
  "affected_files": [
    "src/nthlayer/metrics/__init__.py (NEW)",
    "src/nthlayer/metrics/semantic_conventions.py (NEW)",
    "src/nthlayer/metrics/recommendations.py (NEW)",
    "src/nthlayer/metrics/analyzers.py (NEW)",
    "src/nthlayer/cli/recommend.py (NEW)",
    "src/nthlayer/cli/lint.py (MODIFY)",
    "src/nthlayer/cli/check_deploy.py (MODIFY)"
  ],
  "key_features": [
    {
      "name": "Semantic Convention Enforcement",
      "description": "Validates metric naming against OTel conventions (http.server.*, rpc.server.*, messaging.*, db.client.*)",
      "benefits": ["Cross-vendor interoperability", "Consistent dashboards", "Future-proof naming"]
    },
    {
      "name": "Service Type Templates",
      "description": "Pre-defined metric sets for common service types",
      "service_types": {
        "api": "HTTP latency, error rates, request rates",
        "grpc": "gRPC method latency, status codes",
        "worker": "Job duration, success/failure rates",
        "queue-consumer": "Message processing, lag, redelivery",
        "database-client": "Query latency, connection pool",
        "gateway": "Upstream health, rate limiting",
        "cache": "Hit/miss ratio, eviction rate"
      }
    },
    {
      "name": "Runtime Metrics",
      "description": "Language-specific runtime metrics",
      "runtimes": {
        "python": "process.runtime.cpython.* (GC, threads)",
        "jvm": "process.runtime.jvm.* (heap, GC, threads)",
        "go": "process.runtime.go.* (goroutines, heap)",
        "nodejs": "process.runtime.nodejs.* (event loop, heap)"
      }
    },
    {
      "name": "CLI Command",
      "command": "nthlayer recommend-metrics",
      "flags": [
        "--service-type TYPE",
        "--runtime RUNTIME",
        "--format {yaml|json|table}",
        "--check-only (exit 1 if missing)"
      ]
    },
    {
      "name": "Lint Integration",
      "description": "nthlayer apply --lint warns on non-standard metric references in alerts"
    },
    {
      "name": "Check-Deploy Integration",
      "description": "Optional --require-otel flag blocks deploy if key semantic metrics missing"
    }
  ],
  "implementation_phases": [
    {
      "phase": 1,
      "name": "Core Recommendation Engine",
      "tasks": [
        "Implement semantic convention registry",
        "Create service type templates",
        "Build recommend-metrics CLI command",
        "Add unit tests"
      ]
    },
    {
      "phase": 2,
      "name": "Lint Integration",
      "tasks": [
        "Add metric naming validation to lint",
        "Warn on legacy/non-standard metric names",
        "Suggest OTel equivalents"
      ]
    },
    {
      "phase": 3,
      "name": "Check-Deploy Integration",
      "tasks": [
        "Add --require-otel flag",
        "Implement metric existence validation",
        "Exit codes for missing metrics"
      ]
    },
    {
      "phase": 4,
      "name": "Future Enhancements",
      "tasks": [
        "Cardinality analysis",
        "Auto-instrumentation detection",
        "Cost estimation for high-cardinality metrics"
      ]
    }
  ],
  "acceptance_criteria": [
    "nthlayer recommend-metrics --service-type api outputs expected HTTP metrics",
    "nthlayer recommend-metrics --runtime python includes CPython metrics",
    "nthlayer apply --lint warns on non-OTel metric names in alerts",
    "nthlayer check-deploy --require-otel exits 1 when http.server.duration missing",
    "Documentation covers all service types and runtimes",
    "Unit tests cover semantic convention validation"
  ],
  "related_beads": [
    "identity-config-loading"
  ],
  "references": [
    "https://opentelemetry.io/docs/specs/semconv/",
    "https://opentelemetry.io/docs/specs/semconv/http/http-metrics/",
    "https://opentelemetry.io/docs/specs/semconv/rpc/rpc-metrics/",
    "https://opentelemetry.io/docs/specs/semconv/messaging/messaging-metrics/"
  ]
}

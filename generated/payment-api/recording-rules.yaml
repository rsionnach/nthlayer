# Recording rules generated by NthLayer
# Pre-computed SLO metrics for dashboard and alert performance
#

groups:
- name: payment-api_slo_metrics
  interval: 30s
  rules:
  - record: slo:requests_total:30d
    expr: sum(increase(http_requests_total{service="payment-api"}[30d]))
    labels:
      service: payment-api
      slo: availability
  - record: slo:requests_success:30d
    expr: sum(increase(http_requests_total{service="payment-api",status!~"5.."}[30d]))
    labels:
      service: payment-api
      slo: availability
  - record: slo:availability:ratio
    expr: slo:requests_success:30d{service="payment-api",slo="availability"} / slo:requests_total:30d{service="payment-api",slo="availability"}
    labels:
      service: payment-api
      slo: availability
      objective: '99.9'
  - record: slo:error_budget_remaining:ratio
    expr: 1 - ((1 - slo:availability:ratio{service="payment-api",slo="availability"})
      / (1 - 0.9990000000000001))
    labels:
      service: payment-api
      slo: availability
      objective: '99.9'
  - record: slo:latency_requests_total:30d
    expr: sum(increase(http_request_duration_seconds_count{service="payment-api"}[30d]))
    labels:
      service: payment-api
      slo: latency-p95
  - record: slo:latency_requests_fast:30d
    expr: sum(increase(http_request_duration_seconds_bucket{service="payment-api",le="0.5"}[30d]))
    labels:
      service: payment-api
      slo: latency-p95
      threshold: 500ms
  - record: slo:latency:ratio
    expr: slo:latency_requests_fast:30d{service="payment-api",slo="latency-p95"} /
      slo:latency_requests_total:30d{service="payment-api",slo="latency-p95"}
    labels:
      service: payment-api
      slo: latency-p95
      objective: '99.0'
  - record: slo:http_request_duration_seconds:p50
    expr: histogram_quantile(0.5, rate(http_request_duration_seconds_bucket{service="payment-api"}[5m]))
    labels:
      service: payment-api
      slo: latency-p95
  - record: slo:http_request_duration_seconds:p95
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{service="payment-api"}[5m]))
    labels:
      service: payment-api
      slo: latency-p95
  - record: slo:http_request_duration_seconds:p99
    expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{service="payment-api"}[5m]))
    labels:
      service: payment-api
      slo: latency-p95
- name: payment-api_health_metrics
  interval: 30s
  rules:
  - record: service:http_requests:rate5m
    expr: sum(rate(http_requests_total{service="payment-api"}[5m]))
    labels:
      service: payment-api
  - record: service:http_errors:rate5m
    expr: sum(rate(http_requests_total{service="payment-api",status=~"5.."}[5m]))
      / sum(rate(http_requests_total{service="payment-api"}[5m]))
    labels:
      service: payment-api
  - record: service:http_request_duration_seconds:p95
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{service="payment-api"}[5m]))
    labels:
      service: payment-api
  - record: service:http_request_duration_seconds:p99
    expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{service="payment-api"}[5m]))
    labels:
      service: payment-api
